<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dream Log</title>
    <style>
      :root {
        --bg: #f6f2ea;
        --ink: #1f1c16;
        --muted: #6b6258;
        --card: #fffaf2;
        --accent: #2b6cb0;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: "Georgia", "Times New Roman", serif;
        color: var(--ink);
        background: radial-gradient(circle at 20% 10%, #fff7e6, var(--bg));
      }
      header {
        padding: 28px 16px 6px;
        text-align: center;
      }
      header h1 { margin: 0; letter-spacing: 1px; }
      header p { margin: 8px 0 0; color: var(--muted); }
      main { max-width: 860px; margin: 28px auto 0; padding: 16px; }
      .entry h2 { margin: 0 0 6px; font-size: 22px; }
      .meta { color: var(--muted); font-size: 14px; margin-bottom: 8px; }
      hr {
        border: none;
        border-top: 1px solid #dccfb9;
      }
      .nav {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        justify-content: center;
        margin: 18px 0 28px;
      }
      .nav a {
        text-decoration: none;
        color: var(--ink);
        border: 1px solid #dccfb9;
        padding: 6px 12px;
        border-radius: 999px;
        background: #fffefb;
      }
      .nav a.active { background: var(--accent); color: white; border-color: var(--accent); }
      .empty {
        text-align: center;
        color: var(--muted);
        padding: 48px 12px;
      }
      @media (max-width: 680px) {
        body { font-size: 16px; line-height: 1.7; }
        header { padding: 20px 12px 4px; }
        header h1 { font-size: 24px; }
        main { margin-top: 20px; padding: 12px; }
        .entry h2 { font-size: 19px; }
        .nav { margin: 12px 0 20px; }
        .nav a { padding: 6px 10px; font-size: 13px; }
      }
      footer {
        text-align: center;
        color: var(--muted);
        font-size: 12px;
        padding: 20px 12px 32px;
      }
      .actions { text-align: center; margin-top: 12px; }
      .actions a { color: var(--accent); text-decoration: none; }
    </style>
  </head>
  <body>
    <header>
      <h1>Dream Log</h1>
    </header>
    <main id="list"></main>
    <div class="nav" id="nav"></div>
    <script>
      const PAGE_SIZE = 15;
      const listEl = document.getElementById("list");
      const navEl = document.getElementById("nav");

      function getPageParam() {
        const p = parseInt(new URLSearchParams(location.search).get("page") || "1", 10);
        return Number.isNaN(p) || p < 1 ? 1 : p;
      }

      function buildPageItems(totalPages, current) {
        if (totalPages <= 11) {
          return Array.from({ length: totalPages }, (_, i) => i + 1);
        }
        const items = new Set([1, totalPages]);
        for (let i = current - 2; i <= current + 2; i += 1) {
          if (i > 1 && i < totalPages) items.add(i);
        }
        const sorted = Array.from(items).sort((a, b) => a - b);
        const out = [];
        let prev = null;
        for (const n of sorted) {
          if (prev && n - prev > 1) out.push("…");
          out.push(n);
          prev = n;
        }
        return out;
      }

      function renderNav(totalPages, page) {
        navEl.innerHTML = "";
        const items = buildPageItems(totalPages, page);
        items.forEach((item) => {
          if (item === "…") {
            const span = document.createElement("span");
            span.textContent = "…";
            span.style.padding = "6px 8px";
            navEl.appendChild(span);
            return;
          }
          const link = document.createElement("a");
          link.href = item === 1 ? "index.html" : `index.html?page=${item}`;
          link.textContent = `Page ${item}`;
          if (item === page) link.classList.add("active");
          navEl.appendChild(link);
        });
      }

      const parseDateParts = (dateStr) => {
        if (!dateStr) return null;
        const match = /^(\d{4})-(\d{1,2})-(\d{1,2})/.exec(dateStr.trim());
        if (!match) return null;
        return {
          y: Number(match[1]),
          m: Number(match[2]),
          d: Number(match[3]),
        };
      };

      const dateKey = (dateStr) => {
        const parts = parseDateParts(dateStr);
        if (!parts) return null;
        return parts.y * 10000 + parts.m * 100 + parts.d;
      };

      function renderPosts(posts) {
        if (posts.length === 0) {
          listEl.innerHTML = '<div class="empty">No posts yet. Use the editor to add entries.</div>';
          return;
        }
        const formatPostedAt = (dateStr) => {
          const parts = parseDateParts(dateStr);
          if (parts) {
            return `posted at ${parts.y}年${parts.m}月${parts.d}日`;
          }
          if (!dateStr) return "";
          const d = new Date(dateStr);
          if (Number.isNaN(d.getTime())) return "";
          return `posted at ${d.getFullYear()}年${d.getMonth() + 1}月${d.getDate()}日`;
        };
        const stripPostedAt = (text) => {
          if (!text) return "";
          return text
            .split("\n")
            .filter((line) => !/^posted at\s+/i.test(line.trim()))
            .join("\n");
        };
        const parts = posts.map((post) => {
          const body = stripPostedAt(post.body || "");
          const safeBody = body.replace(/</g, "&lt;").replace(/>/g, "&gt;");
          const bodyHtml = safeBody
            .replace(/\r\n/g, "\n")
            .replace(/\n{2,}/g, "\n\n")
            .replace(/\n\n/g, "__P__")
            .replace(/\n/g, " ")
            .replace(/__P__/g, "<br><br>");
          const postedAt = formatPostedAt(post.date || "");
          return `
            <div class="entry">
              <h2>${post.title || "Untitled"}</h2>
              <br>
              <div>${bodyHtml}</div>
              ${postedAt ? `<br><div>${postedAt}</div>` : ""}
            </div>
          `;
        });
        const separator = "<br><hr><br>";
        const topRule = "<hr><br>";
        listEl.innerHTML = parts.length ? topRule + parts.join(separator) : "";
      }

      async function load() {
        let posts = [];
        try {
          const res = await fetch(`posts.json?ts=${Date.now()}`);
          posts = await res.json();
        } catch (err) {
          listEl.innerHTML = '<div class="empty">posts.json not found. Generate or upload it first.</div>';
          navEl.innerHTML = "";
          return;
        }
        const jstTodayStr = () => {
          const now = new Date();
          const utc = now.getTime() + now.getTimezoneOffset() * 60000;
          const jst = new Date(utc + 9 * 60 * 60000);
          const y = jst.getFullYear();
          const m = String(jst.getMonth() + 1).padStart(2, "0");
          const d = String(jst.getDate()).padStart(2, "0");
          return `${y}-${m}-${d}`;
        };
        const todayStr = jstTodayStr();
        const todayKey = dateKey(todayStr);
        posts = posts.filter((p) => {
          const key = dateKey(p.date);
          return key === null || key <= todayKey;
        });
        posts.sort((a, b) => {
          const ak = dateKey(a.date);
          const bk = dateKey(b.date);
          if (ak === null && bk === null) return 0;
          if (ak === null) return 1;
          if (bk === null) return -1;
          return bk - ak;
        });
        const page = getPageParam();
        const totalPages = Math.max(1, Math.ceil(posts.length / PAGE_SIZE));
        const start = (page - 1) * PAGE_SIZE;
        renderPosts(posts.slice(start, start + PAGE_SIZE));
        renderNav(totalPages, Math.min(page, totalPages));
      }

      load();
    </script>
  </body>
</html>
